require 'builder'

local b = genie.Builder.new()

b:component('dispatch')
	b:clock_sink('clk')
	b:reset_sink('reset')
	b:rs_src('out', 'clk')
		b:signal('valid', 'o_valid')
		b:signal('ready', 'i_ready')
		b:signal('data', 'o_data', 'WIDTH')

b:component('inverter')
	b:clock_sink('clk')
	b:reset_sink('reset')
	b:rs_sink('in', 'clk')
		b:signal('valid', 'i_valid')
		b:signal('ready', 'o_ready')
		b:signal('data', 'i_data', 'WIDTH')
	b:rs_src('out', 'clk')
		b:signal('valid', 'o_valid')
		b:signal('ready', 'i_ready')
		b:signal('data', 'o_data', 'WIDTH')
	
b:component('xorer')
	b:clock_sink('clk')
	b:reset_sink('reset')
	b:rs_sink('in', 'clk')
		b:signal('valid', 'i_valid')
		b:signal('ready', 'o_ready')
		b:signal('data', 'i_data', 'WIDTH')	
	b:rs_src('out', 'clk')
		b:signal('valid', 'o_valid')
		b:signal('ready', 'i_ready')
		b:signal('data', 'o_data', 'WIDTH')

b:component('reverser')
	b:clock_sink('clk')
	b:reset_sink('reset')
	b:rs_sink('in', 'clk')
		b:signal('valid', 'i_valid')
		b:signal('ready', 'o_ready')
		b:signal('data', 'i_data', 'WIDTH')
	b:rs_src('out', 'clk')
		b:signal('valid', 'o_valid')
		b:signal('ready', 'i_ready')
		b:signal('data', 'o_data', 'WIDTH')

b:system('sm_test')
    b:clock_sink('clk')
    b:reset_sink('reset')
	b:instance('dispatch', 'the_dispatch')
		b:int_param('WIDTH', '16')
	b:instance('inverter', 'the_inverter')
		b:int_param('WIDTH', '16')
	b:instance('reverser', 'the_reverser')
		b:int_param('WIDTH', '16')
	b:instance('xorer', 'xorro')
		b:int_param('WIDTH', '16')
		
	for dest in Set.mkvalues{'the_dispatch', 'the_inverter', 'the_reverser', 'xorro'} do
		b:clock_link('clk', dest .. '.' .. 'clk')
		b:reset_link('reset', dest .. '.' .. 'reset')
	end
	
	b:rs_link('the_dispatch.out', 'the_inverter.in')
	b:rs_link('the_dispatch.out', 'the_reverser.in')
	b:rs_link('the_inverter.out', 'xorro.in')
	b:rs_link('the_reverser.out', 'xorro.in')
	b:export ('xorro.out', 'out')
